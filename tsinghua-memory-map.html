<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸…åå›å¿†åœ°å›¾ - å¢å¼ºç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #722F37, #8B4A52);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1000;
        }
        
        .map-container {
            position: relative;
            width: 100vw;
            height: calc(100vh - 80px);
            overflow: hidden;
            background: #f0f0f0;
        }
        
        .campus-map {
            position: absolute;
            cursor: grab;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            transform-origin: 0 0;
        }
        
        .campus-map:active {
            cursor: grabbing;
        }
        
        .campus-map.adding-marker {
            cursor: crosshair !important;
        }
        
        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
        
        .zoom-controls {
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .zoom-btn {
            width: 50px;
            height: 50px;
            border: none;
            background: white;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .zoom-btn:hover {
            background: #f0f0f0;
        }
        
        .zoom-btn:not(:last-child) {
            border-bottom: 1px solid #eee;
        }
        
        .info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 320px;
            z-index: 1000;
        }
        
        .coordinate-display {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            font-family: monospace;
            z-index: 1000;
        }
        
        .zoom-display {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            font-family: monospace;
            z-index: 1000;
        }
        
        .map-marker {
            position: absolute;
            width: 25px;
            height: 25px;
            background: #722F37;
            border: 1px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px; /* emojiå¤§å°è°ƒæ•´ä¸º12pxï¼Œå’Œ25pxæ ‡è®°åŒ¹é… - å¯åœ¨æ­¤ä¿®æ”¹ */
            cursor: pointer;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
            z-index: 500;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            pointer-events: auto;
        }
        
        .map-marker:hover {
            transform: translate(-50%, -50%) scale(1.3);
            z-index: 600;
        }
        
        /* å­£èŠ‚é¢œè‰²é…ç½® - å¯ä»¥åœ¨è¿™é‡Œä¿®æ”¹é¢œè‰² */
        .map-marker.season-spring { 
            background: #10B981; /* æ˜¥å¤© - ç»¿è‰² */
        }
        .map-marker.season-summer { 
            background: #e3c0d0; /* å¤å¤© - ç²‰è‰² */
        }
        .map-marker.season-autumn { 
            background: #c68c5c; /* ç§‹å¤© - å’–è‰² */
        }
        .map-marker.season-winter { 
            background: #c6d0e0; /* å†¬å¤© - è“è‰² */
        }
        .map-marker.season-default { 
            background: #722F37; /* é»˜è®¤ - æ·±çº¢è‰² */
        }
        
        .add-marker-btn, .data-management-btn {
            background: #722F37;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            width: 100%;
            margin-top: 10px;
        }
        
        .data-management-btn {
            background: #059669;
        }
        
        .add-marker-btn:hover {
            background: #5a252a;
        }
        
        .data-management-btn:hover {
            background: #047857;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .modal-content.large {
            max-width: 800px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-input, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }
        
        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #722F37;
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .btn-primary {
            background: #722F37;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            background: #5a252a;
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .btn-danger {
            background: #dc2626;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .btn-danger:hover {
            background: #b91c1c;
        }
        
        .btn-edit {
            background: #059669;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            margin-right: 5px;
        }
        
        .btn-edit:hover {
            background: #047857;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            z-index: 1500;
        }
        
        .error-info {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .data-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }
        
        .data-table tbody tr:hover {
            background: #f9fafb;
        }
        
        .grade-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }
        
        .grade-default { background: #6B7280; } /* å¹´ä»½å¾½ç« æ ·å¼ */
        
        .season-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .season-spring { background: #dcfce7; color: #166534; }
        .season-summer { background: #dbeafe; color: #1e40af; }
        .season-autumn { background: #fed7aa; color: #9a3412; }
        .season-winter { background: #f1f5f9; color: #334155; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #722F37;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6b7280;
            margin-top: 5px;
        }
        
        .adding-mode-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(114, 47, 55, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            z-index: 1500;
            pointer-events: none;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        /* å›¾ç‰‡ä¸Šä¼ ç›¸å…³æ ·å¼ */
        .image-upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 15px;
        }
        
        .image-upload-area:hover {
            border-color: #722F37;
            background: #f9f9f9;
        }
        
        .image-upload-area.dragover {
            border-color: #722F37;
            background: #f0f9f4;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 6px;
            margin-top: 10px;
        }
        
        .image-remove-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
        }
        
        /* å›å¿†å±•ç¤ºæ ·å¼ */
        .memory-content {
            background: white;
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            max-width: 600px;
            max-height: 85vh;
            position: relative;
            overflow: hidden;
            margin: 20px auto;
            min-height: 300px; /* æ— å›¾ç‰‡æ—¶çš„æœ€å°é«˜åº¦ */
            display: flex;
            flex-direction: column;
        }
        
        /* æœ‰å›¾ç‰‡æ—¶å¢åŠ æœ€å°é«˜åº¦ */
        .memory-content.has-image {
            min-height: 400px; /* æœ‰å›¾ç‰‡æ—¶çš„æœ€å°é«˜åº¦ */
            min-width: 400px;
        }
        
        .memory-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 25px 50px 0 25px; /* å³ä¾§ç•™æ›´å¤šç©ºé—´ç»™å…³é—­æŒ‰é’® */
            min-height: 60px;
            flex-shrink: 0;
        }
        
        .memory-title {
            font-size: 18px;
            font-weight: 600;
            color: #722F37;
            line-height: 1.4;
            flex: 1;
            margin-right: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .memory-title-emoji {
            font-size: 20px;
        }
        
        .memory-badges {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
        }
        
        .memory-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #ffffff;
        }
        
        /* ä¸åŒå¸ƒå±€ä¸‹çš„å›¾ç‰‡é«˜åº¦æ§åˆ¶ */
        .memory-main-content.horizontal-layout .memory-image {
            /* æ¨ªå‘å¸ƒå±€ï¼šä½¿ç”¨JavaScriptåŠ¨æ€è®¡ç®—é«˜åº¦ï¼Œé˜²æ­¢è¶…å‡ºæ–‡å­—åŒºåŸŸ */
            max-height: 350px; 
        }
        
        .memory-main-content.vertical-layout .memory-image {
            max-height: 250px; /* ç«–å‘å¸ƒå±€ï¼šé™åˆ¶å›¾ç‰‡æœ€å¤§é«˜åº¦ï¼Œé˜²æ­¢å®½å›¾ç‰‡è¿‡å¤§ */
        }
        
        .memory-body {
            padding: 20px;
            min-height: 200px;
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            min-height: 0; /* é‡è¦ï¼šå…è®¸flexå­é¡¹æ”¶ç¼© */
        }
        
        .memory-description {
            line-height: 1.6;
            color: #374151;
            margin-bottom: 15px;
            max-width: 400px;
            word-wrap: break-word;
            word-break: break-all;
            white-space: pre-wrap;
        }
        
        .memory-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #6b7280;
            margin-top: 15px;
            padding: 15px 0;
            border-top: 1px solid #e5e7eb;
            flex-shrink: 0;
            background: white;
            position: sticky;
            bottom: 0;
        }
        
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            z-index: 10;
            transition: all 0.2s ease;
        }
        
        .close-btn:hover {
            background: rgba(0, 0, 0, 0.7);
        }
        
        .year-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }
        
        .year-input:focus {
            outline: none;
            border-color: #722F37;
        }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .memory-text-scrollable::-webkit-scrollbar {
            width: 6px;
        }
        
        .memory-text-scrollable::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .memory-text-scrollable::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .memory-text-scrollable::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* å›¾ç‰‡å’Œå†…å®¹çš„è‡ªé€‚åº”å¸ƒå±€ */
        .memory-main-content {
            display: flex;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }
        
        .memory-main-content.vertical-layout {
            flex-direction: column;
        }
        
        .memory-main-content.horizontal-layout {
            flex-direction: row;
        }
        
        .memory-image-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 10px;
            flex-shrink: 0;
        }
        
        /* æ¨ªå‘å¸ƒå±€æ—¶å›¾ç‰‡å®¹å™¨é¡¶éƒ¨å¯¹é½ */
        .memory-main-content.horizontal-layout .memory-image-container {
            align-items: flex-start; /* ç¡®ä¿é¡¶éƒ¨å¯¹é½ */
            padding-top: 0; /* ç§»é™¤é¡¶éƒ¨paddingï¼Œä¸æ–‡å­—åŒºåŸŸå¯¹é½ */
        }
        
        .memory-main-content.horizontal-layout .memory-image-container {
            width: 40%; /* æ¨ªå‘å¸ƒå±€ï¼šå›¾ç‰‡å 40%ï¼Œæ–‡å­—å 60% - å¯åœ¨æ­¤ä¿®æ”¹æ¯”ä¾‹ */
            max-width: 50%;
            padding-right: 10px;
            padding-top: 0; /* é¡¶éƒ¨å¯¹é½ */
            flex-shrink: 0;
            align-items: flex-start; /* ç¡®ä¿é¡¶éƒ¨å¯¹é½ */
            /* è®©å›¾ç‰‡å®¹å™¨é«˜åº¦è·Ÿéšæ–‡å­—å†…å®¹ï¼Œè€Œä¸æ˜¯å›ºå®šç™¾åˆ†æ¯” */
        }
        
        .memory-main-content.vertical-layout .memory-image-container {
            height: 40%; /* ç«–å‘å¸ƒå±€ï¼šå›¾ç‰‡å 40%ï¼Œæ–‡å­—å 60% - å¯åœ¨æ­¤ä¿®æ”¹æ¯”ä¾‹ */
            max-height: 40%;
            padding-bottom: 10px;
            flex-shrink: 0;
        }
        
        .memory-text-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }
        
        .memory-text-scrollable {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        /* ä½œè€…ä¿¡æ¯æ ·å¼ */
        .author-info {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: #666;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .info-icon {
            width: 20px;
            height: 20px;
            background: #722F37;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .info-icon:hover {
            background: #8B4A52;
            transform: scale(1.1);
        }
        
        /* Infoå¼¹çª—æ ·å¼ */
        .info-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            backdrop-filter: blur(5px);
        }
        
        .info-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .info-modal h3 {
            color: #722F37;
            margin-bottom: 20px;
            font-size: 20px;
            text-align: center;
        }
        
        .info-modal p {
            line-height: 1.6;
            margin-bottom: 15px;
            color: #333;
        }
        
        .info-modal .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .info-modal .close-btn:hover {
            color: #722F37;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“ æ¸…åå›å¿†åœ°å›¾</h1>
    </div>
    
    <div class="map-container" id="map-container">
        <!-- æ ¡å›­åœ°å›¾ -->
        <img id="campus-map" 
             src="campus_map_2023.jpg" 
             alt="æ¸…åå¤§å­¦æ ¡å›­åœ°å›¾" 
             class="campus-map"
             draggable="false">
        
        <!-- æ·»åŠ æ¨¡å¼æç¤º -->
        <div class="adding-mode-hint" id="adding-hint" style="display: none;">
            ğŸ“ ç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®
        </div>
        
        <!-- åŠ è½½æç¤º -->
        <div class="loading" id="loading">
            <div>ğŸ“ æ­£åœ¨åŠ è½½æ ¡å›­åœ°å›¾...</div>
            <div style="font-size: 12px; color: #666; margin-top: 10px;">
                å›¾ç‰‡è·¯å¾„: campus_map_2023.jpg
            </div>
        </div>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="controls">
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomIn()" title="æ”¾å¤§">+</button>
                <button class="zoom-btn" onclick="zoomOut()" title="ç¼©å°">âˆ’</button>
                <button class="zoom-btn" onclick="resetZoom()" title="é‡ç½®">âŒ‚</button>
            </div>
        </div>
        
        <!-- ä¿¡æ¯é¢æ¿ -->
        <div class="info-panel">
            <h3 style="margin-bottom: 15px;">ğŸ¯ æ“ä½œæŒ‡å—</h3>
            <ul style="list-style: none; line-height: 1.6;">
                <li>ğŸ–±ï¸ æ‹–æ‹½ç§»åŠ¨åœ°å›¾</li>
                <li>ğŸ” ä½¿ç”¨+/-æŒ‰é’®æˆ–æ»šè½®ç¼©æ”¾</li>
                <li>ğŸ‘† ç‚¹å‡»æ ‡è®°æŸ¥çœ‹å›å¿†</li>
            </ul>
            <button class="add-marker-btn" onclick="startAddingMarker(event)">
                â• æ·»åŠ å›å¿†ç‚¹
            </button>
            <button class="data-management-btn" onclick="openDataManagement()">
                ğŸ“Š è®°å½•ç®¡ç†
            </button>
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; font-size: 14px; color: #666;">
                <div>å›å¿†æ€»æ•°: <span id="memory-count">0</span></div>
                <div style="margin-top: 5px;">
                    <div>åœ°å›¾çŠ¶æ€: <span id="map-status">åˆå§‹åŒ–ä¸­...</span></div>
                </div>
            </div>
        </div>
        
        <!-- åæ ‡æ˜¾ç¤º -->
        <div class="coordinate-display" id="coordinate-display">
            åæ ‡: ç­‰å¾…åŠ è½½...
        </div>
        
        <!-- ç¼©æ”¾æ˜¾ç¤º -->
        <div class="zoom-display" id="zoom-display">
            ç¼©æ”¾: ç­‰å¾…åŠ è½½...
        </div>
    </div>
    
    <!-- æ·»åŠ å›å¿†æ¨¡æ€æ¡† -->
    <div id="memory-modal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px;">ğŸ“ æ·»åŠ æ–°å›å¿†</h3>
            <form id="memory-form">
                <div class="form-group">
                    <label class="form-label">ğŸ“ åæ ‡ä½ç½®</label>
                    <input type="text" id="marker-coords" class="form-input" readonly placeholder="ç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®">
                </div>
                
                <div class="form-group">
                    <label class="form-label">ğŸ·ï¸ æ ‡é¢˜</label>
                    <input type="text" id="memory-title" class="form-input" placeholder="ä¾‹å¦‚ï¼šå›¾ä¹¦é¦†åˆé‡ã€æ¯•ä¸šå…¸ç¤¼" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ğŸ“ è‡ªå®šä¹‰æ ‡è®°å›¾æ ‡</label>
                    <input type="text" id="memory-emoji" class="form-input" placeholder="ä¾‹å¦‚ï¼šğŸ«ğŸ“šğŸŒ¸ğŸ’• (å¯é€‰ï¼Œé»˜è®¤ä¸ºğŸ“)" maxlength="2">
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                        è¾“å…¥ä¸€ä¸ªemojiä½œä¸ºåœ°å›¾ä¸Šçš„æ ‡è®°å›¾æ ‡ï¼Œç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤çš„ğŸ“
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ğŸ¢ åœ°ç‚¹åç§°</label>
                    <input type="text" id="location-name" class="form-input" placeholder="ä¾‹å¦‚ï¼šç´«è† 16 å·æ¥¼ã€ä¸œå—é—¨ã€å­¦å ‚è·¯ä¸æ–°æ°‘è·¯åå­—è·¯å£">
                </div>
                
                <div class="form-group">
                    <label class="form-label">ğŸ–¼ï¸ ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
                    <div class="image-upload-area" onclick="document.getElementById('image-input').click()">
                        <input type="file" id="image-input" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                        <div id="upload-text">
                            ğŸ“· ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„<br>
                            <small style="color: #666;">æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œå»ºè®®å¤§å°ä¸è¶…è¿‡ 5MB<br>å»ºè®®å›¾ç‰‡æ¯”ä¾‹ä¸çª„äº 3:4ï¼Œä¸å®½äº 16:9</small>
                        </div>
                        <img id="image-preview" class="image-preview" style="display: none;">
                        <button type="button" id="remove-image-btn" class="image-remove-btn" style="display: none;" onclick="removeImage(event)">åˆ é™¤å›¾ç‰‡</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ğŸ’­ å›å¿†å†…å®¹</label>
                    <textarea id="memory-content" class="form-textarea" placeholder="åœ¨è¿™é‡Œè®°å½•ä½ çš„å›å¿†ã€æ„Ÿå—..." required></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ğŸŒ¸ å­£èŠ‚</label>
                        <select id="memory-season" class="form-input">
                            <option value="">é€‰æ‹©å­£èŠ‚ï¼ˆå¯é€‰ï¼‰</option>
                            <option value="spring">ğŸŒ¸ æ˜¥å¤©</option>
                            <option value="summer">ğŸŒ å¤å¤©</option>
                            <option value="autumn">ğŸ‚ ç§‹å¤©</option>
                            <option value="winter">â„ï¸ å†¬å¤©</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ğŸ“… å¹´ä»½</label>
                        <input type="number" id="memory-year" class="year-input" placeholder="ä¾‹å¦‚ï¼š2021" min="1970" max="2025">
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn-secondary" onclick="closeMemoryModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn-primary">ä¿å­˜å›å¿†</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ç¼–è¾‘å›å¿†æ¨¡æ€æ¡† -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px;">âœï¸ ç¼–è¾‘å›å¿†</h3>
            <form id="edit-form">
                <input type="hidden" id="edit-memory-id">
                
                <div class="form-group">
                    <label class="form-label">ğŸ“ åæ ‡ä½ç½®</label>
                    <input type="text" id="edit-marker-coords" class="form-input" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ğŸ·ï¸ æ ‡é¢˜</label>
                    <input type="text" id="edit-memory-title" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ğŸ“ è‡ªå®šä¹‰æ ‡è®°å›¾æ ‡</label>
                    <input type="text" id="edit-memory-emoji" class="form-input" placeholder="ä¾‹å¦‚ï¼šğŸ«ğŸ“šğŸŒ¸ğŸ’• (å¯é€‰ï¼Œé»˜è®¤ä¸ºğŸ“)" maxlength="2">
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                        è¾“å…¥ä¸€ä¸ªemojiä½œä¸ºåœ°å›¾ä¸Šçš„æ ‡è®°å›¾æ ‡ï¼Œç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤çš„ğŸ“
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ğŸ¢ åœ°ç‚¹åç§°</label>
                    <input type="text" id="edit-location-name" class="form-input">
                </div>
                
                <div class="form-group">
                    <label class="form-label">ğŸ–¼ï¸ å›¾ç‰‡</label>
                    <div class="image-upload-area" onclick="document.getElementById('edit-image-input').click()">
                        <input type="file" id="edit-image-input" accept="image/*" style="display: none;" onchange="handleEditImageUpload(event)">
                        <div id="edit-upload-text">
                            ğŸ“· ç‚¹å‡»æ›´æ¢å›¾ç‰‡æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„
                        </div>
                        <img id="edit-image-preview" class="image-preview" style="display: none;">
                        <button type="button" id="edit-remove-image-btn" class="image-remove-btn" style="display: none;" onclick="removeEditImage(event)">åˆ é™¤å›¾ç‰‡</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ğŸ’­ å›å¿†å†…å®¹</label>
                    <textarea id="edit-memory-content" class="form-textarea" required></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ğŸŒ¸ å­£èŠ‚</label>
                        <select id="edit-memory-season" class="form-input">
                            <option value="">é€‰æ‹©å­£èŠ‚ï¼ˆå¯é€‰ï¼‰</option>
                            <option value="spring">ğŸŒ¸ æ˜¥å¤©</option>
                            <option value="summer">ğŸŒ å¤å¤©</option>
                            <option value="autumn">ğŸ‚ ç§‹å¤©</option>
                            <option value="winter">â„ï¸ å†¬å¤©</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ğŸ“… å¹´ä»½</label>
                        <input type="number" id="edit-memory-year" class="year-input" placeholder="ä¾‹å¦‚ï¼š2020" min="2000" max="2025">
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn-primary">æ›´æ–°å›å¿†</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- æ•°æ®ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="data-management-modal" class="modal">
        <div class="modal-content large">
            <h3 style="margin-bottom: 20px;">ğŸ“Š æ•°æ®è®°å½•ä¸­å¿ƒ</h3>
            
            <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-memories">0</div>
                    <div class="stat-label">æ€»å›å¿†æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="recent-memories">0</div>
                    <div class="stat-label">æœ¬æœˆæ–°å¢</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="year-distribution">0</div>
                    <div class="stat-label">å¹´ä»½åˆ†å¸ƒ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="season-distribution">0</div>
                    <div class="stat-label">å­£èŠ‚åˆ†å¸ƒ</div>
                </div>
            </div>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn-secondary" onclick="exportData()">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
                <button class="btn-secondary" onclick="importData()">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
                <button class="btn-secondary" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
                <button class="btn-secondary" onclick="refreshDataTable()">ğŸ”„ åˆ·æ–°</button>
            </div>
            
            <!-- æ•°æ®è¡¨æ ¼ -->
            <div style="overflow-x: auto;">
                <table class="data-table" id="data-table">
                    <thead>
                        <tr>
                            <th>æ ‡é¢˜</th>
                            <th>åœ°ç‚¹</th>
                            <th>åæ ‡</th>
                            <th>å­£èŠ‚</th>
                            <th>å¹´ä»½</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
            
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn-primary" onclick="closeDataManagement()">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <!-- æŸ¥çœ‹å›å¿†æ¨¡æ€æ¡† -->
    <div id="view-modal" class="modal">
        <div id="view-content"></div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let mapScale = 1;
        let mapOffsetX = 0;
        let mapOffsetY = 0;
        let mapWidth = 0;
        let mapHeight = 0;
        let containerWidth = 0;
        let containerHeight = 0;
        let isDragging = false;
        let isAddingMarker = false;
        let clickedCoords = null;
        let memories = [];
        let mapLoaded = false;
        let currentImageData = null; // å­˜å‚¨å½“å‰ä¸Šä¼ çš„å›¾ç‰‡æ•°æ®
        let currentEditImageData = null; // å­˜å‚¨ç¼–è¾‘æ—¶çš„å›¾ç‰‡æ•°æ®
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–åœ°å›¾');
            initMap();
            setupImageUpload();
        });
        
        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            const mapContainer = document.getElementById('map-container');
            const mapImage = document.getElementById('campus-map');
            
            console.log('å¼€å§‹åˆå§‹åŒ–åœ°å›¾');
            updateMapStatus('æ­£åœ¨åŠ è½½å›¾ç‰‡...');
            
            // å›¾ç‰‡åŠ è½½æˆåŠŸå¤„ç†
            mapImage.onload = function() {
                console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ');
                console.log('å›¾ç‰‡å°ºå¯¸:', this.naturalWidth, 'x', this.naturalHeight);
                
                mapWidth = this.naturalWidth;
                mapHeight = this.naturalHeight;
                containerWidth = mapContainer.offsetWidth;
                containerHeight = mapContainer.offsetHeight;
                
                console.log('å®¹å™¨å°ºå¯¸:', containerWidth, 'x', containerHeight);
                
                // è®¡ç®—åˆå§‹ç¼©æ”¾ä»¥é€‚åº”å®¹å™¨ - ä½¿ç”¨å¾ˆå°çš„æ¯”ä¾‹
                mapScale = 0.1; // ç›´æ¥è®¾ç½®ä¸º10%ç¼©æ”¾
                
                console.log('åˆå§‹ç¼©æ”¾æ¯”ä¾‹:', mapScale);
                
                // å±…ä¸­æ˜¾ç¤º
                mapOffsetX = (containerWidth - mapWidth * mapScale) / 2;
                mapOffsetY = (containerHeight - mapHeight * mapScale) / 2;
                
                updateMapTransform();
                updateZoomDisplay();
                updateCoordinateDisplay(mapWidth / 2, mapHeight / 2);
                
                mapLoaded = true;
                document.getElementById('loading').style.display = 'none';
                updateMapStatus('åœ°å›¾åŠ è½½å®Œæˆ - å¯ä»¥å¼€å§‹æ·»åŠ å›å¿†ç‚¹');
                
                setupEvents();
                loadMemories();
                renderMarkers();
                updateMemoryCount();
            };
            
            // å›¾ç‰‡åŠ è½½å¤±è´¥å¤„ç†
            mapImage.onerror = function() {
                console.error('å›¾ç‰‡åŠ è½½å¤±è´¥: campus_map_2023.jpg');
                updateMapStatus('å›¾ç‰‡åŠ è½½å¤±è´¥');
                
                document.getElementById('loading').innerHTML = `
                    <div class="error-info">
                        <h3 style="margin-bottom: 10px;">âš ï¸ å›¾ç‰‡åŠ è½½å¤±è´¥</h3>
                        <p>æ— æ³•åŠ è½½æ ¡å›­åœ°å›¾: <strong>campus_map_2023.jpg</strong></p>
                        <p style="margin-top: 10px; font-size: 14px;">è¯·æ£€æŸ¥ï¼š</p>
                        <ul style="text-align: left; margin: 10px 0; font-size: 14px;">
                            <li>â€¢ å›¾ç‰‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨äºå½“å‰ç›®å½•</li>
                            <li>â€¢ æ–‡ä»¶åæ˜¯å¦æ­£ç¡®ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰</li>
                            <li>â€¢ å›¾ç‰‡æ ¼å¼æ˜¯å¦æ”¯æŒ</li>
                        </ul>
                        <button class="btn-primary" onclick="retryLoadImage()" style="margin-top: 15px;">
                            é‡è¯•åŠ è½½
                        </button>
                    </div>
                `;
            };
            
            // å¼€å§‹åŠ è½½å›¾ç‰‡
            console.log('å¼€å§‹åŠ è½½å›¾ç‰‡:', mapImage.src);
        }
        
        // è®¾ç½®å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
        function setupImageUpload() {
            // æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
            const uploadArea = document.querySelector('.image-upload-area');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight(e) {
                uploadArea.classList.add('dragover');
            }
            
            function unhighlight(e) {
                uploadArea.classList.remove('dragover');
            }
            
            uploadArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    handleImageFile(files[0]);
                }
            }
        }
        
        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                handleImageFile(file);
            }
        }
        
        function handleImageFile(file) {
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ5MBé™åˆ¶ï¼‰
            if (file.size > 5 * 1024 * 1024) {
                alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MBï¼');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                currentImageData = e.target.result;
                
                // æ˜¾ç¤ºé¢„è§ˆ
                const preview = document.getElementById('image-preview');
                const uploadText = document.getElementById('upload-text');
                const removeBtn = document.getElementById('remove-image-btn');
                
                preview.src = currentImageData;
                preview.style.display = 'block';
                uploadText.style.display = 'none';
                removeBtn.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
        
        // åˆ é™¤å›¾ç‰‡
        function removeImage(event) {
            event.stopPropagation();
            
            currentImageData = null;
            
            const preview = document.getElementById('image-preview');
            const uploadText = document.getElementById('upload-text');
            const removeBtn = document.getElementById('remove-image-btn');
            const input = document.getElementById('image-input');
            
            preview.style.display = 'none';
            uploadText.style.display = 'block';
            removeBtn.style.display = 'none';
            input.value = '';
        }
        
        // ç¼–è¾‘æ—¶çš„å›¾ç‰‡å¤„ç†
        function handleEditImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                handleEditImageFile(file);
            }
        }
        
        function handleEditImageFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MBï¼');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                currentEditImageData = e.target.result;
                console.log('å›¾ç‰‡ä¸Šä¼ å®Œæˆ - æ–°å›¾ç‰‡é•¿åº¦:', currentEditImageData ? currentEditImageData.length : 0);
                
                const preview = document.getElementById('edit-image-preview');
                const uploadText = document.getElementById('edit-upload-text');
                const removeBtn = document.getElementById('edit-remove-image-btn');
                
                preview.src = currentEditImageData;
                preview.style.display = 'block';
                uploadText.style.display = 'none';
                removeBtn.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
        
        function removeEditImage(event) {
            event.stopPropagation();
            
            currentEditImageData = null;
            console.log('å›¾ç‰‡å·²åˆ é™¤ - currentEditImageDataè®¾ä¸ºnull');
            
            const preview = document.getElementById('edit-image-preview');
            const uploadText = document.getElementById('edit-upload-text');
            const removeBtn = document.getElementById('edit-remove-image-btn');
            const input = document.getElementById('edit-image-input');
            
            preview.style.display = 'none';
            uploadText.style.display = 'block';
            removeBtn.style.display = 'none';
            input.value = '';
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬
        function setupEvents() {
            const mapContainer = document.getElementById('map-container');
            const mapImage = document.getElementById('campus-map');
            
            // åœ°å›¾ç‚¹å‡»äº‹ä»¶
            mapContainer.addEventListener('click', function(e) {
                if (isDragging || !mapLoaded) return;
                
                const rect = mapContainer.getBoundingClientRect();
                const containerX = e.clientX - rect.left;
                const containerY = e.clientY - rect.top;
                
                // è½¬æ¢ä¸ºåœ°å›¾åæ ‡
                const mapX = (containerX - mapOffsetX) / mapScale;
                const mapY = (containerY - mapOffsetY) / mapScale;
                
                console.log('ç‚¹å‡»ä½ç½® - å®¹å™¨åæ ‡:', containerX, containerY);
                console.log('ç‚¹å‡»ä½ç½® - åœ°å›¾åæ ‡:', mapX, mapY);
                
                if (isAddingMarker) {
                    // è®°å½•ç‚¹å‡»çš„åæ ‡
                    clickedCoords = { x: Math.round(mapX), y: Math.round(mapY) };
                    document.getElementById('marker-coords').value = `${clickedCoords.x}, ${clickedCoords.y}`;
                    
                    // æ˜¾ç¤ºç¡®è®¤ä½ç½®çš„æç¤º
                    showLocationConfirmation(mapX, mapY);
                }
                
                updateCoordinateDisplay(mapX, mapY);
            });
            
            // é¼ æ ‡ç§»åŠ¨æ˜¾ç¤ºåæ ‡
            mapContainer.addEventListener('mousemove', function(e) {
                if (isDragging || !mapLoaded) return;
                
                const rect = mapContainer.getBoundingClientRect();
                const containerX = e.clientX - rect.left;
                const containerY = e.clientY - rect.top;
                
                const mapX = (containerX - mapOffsetX) / mapScale;
                const mapY = (containerY - mapOffsetY) / mapScale;
                
                updateCoordinateDisplay(mapX, mapY);
            });
            
            // æ‹–æ‹½åŠŸèƒ½
            let startX, startY, initialOffsetX, initialOffsetY;
            
            mapImage.addEventListener('mousedown', function(e) {
                if (isAddingMarker || !mapLoaded) return;
                
                isDragging = false;
                startX = e.clientX;
                startY = e.clientY;
                initialOffsetX = mapOffsetX;
                initialOffsetY = mapOffsetY;
                
                function onMouseMove(e) {
                    e.preventDefault();
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    
                    if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
                        isDragging = true;
                    }
                    
                    mapOffsetX = initialOffsetX + deltaX;
                    mapOffsetY = initialOffsetY + deltaY;
                    
                    updateMapTransform();
                }
                
                function onMouseUp() {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                    
                    setTimeout(() => {
                        isDragging = false;
                    }, 50);
                }
                
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
            
            // æ»šè½®ç¼©æ”¾
            mapContainer.addEventListener('wheel', function(e) {
                e.preventDefault();
                if (!mapLoaded) return;
                
                const oldScale = mapScale;
                
                if (e.deltaY < 0) {
                    mapScale = Math.min(mapScale * 1.2, 3);
                } else {
                    mapScale = Math.max(mapScale / 1.2, 0.1);
                }
                
                // ä»¥åœ°å›¾ä¸­å¿ƒä¸ºç¼©æ”¾ä¸­å¿ƒ
                const mapCenterX = mapOffsetX + (mapWidth * oldScale) / 2;
                const mapCenterY = mapOffsetY + (mapHeight * oldScale) / 2;
                
                // é‡æ–°è®¡ç®—åç§»é‡ä»¥ä¿æŒåœ°å›¾ä¸­å¿ƒä½ç½®
                mapOffsetX = mapCenterX - (mapWidth * mapScale) / 2;
                mapOffsetY = mapCenterY - (mapHeight * mapScale) / 2;
                
                updateMapTransform();
                updateZoomDisplay();
            });
        }
        
        // å¼€å§‹æ·»åŠ æ ‡è®°
        function startAddingMarker(event) {
            // é˜²æ­¢äº‹ä»¶å†’æ³¡åˆ°åœ°å›¾ç‚¹å‡»äº‹ä»¶
            if (event) {
                event.stopPropagation();
            }
            
            if (!mapLoaded) {
                alert('è¯·ç­‰å¾…åœ°å›¾åŠ è½½å®Œæˆ');
                return;
            }
            
            isAddingMarker = true;
            
            // æ›´æ–°åœ°å›¾æ ·å¼
            const mapImage = document.getElementById('campus-map');
            mapImage.classList.add('adding-marker');
            
            // æ˜¾ç¤ºæç¤º
            document.getElementById('adding-hint').style.display = 'block';
            
            // æ›´æ–°ä¿¡æ¯é¢æ¿
            const infoPanel = document.querySelector('.info-panel');
            const currentContent = infoPanel.innerHTML;
            infoPanel.innerHTML = `
                <h3 style="margin-bottom: 15px;">ğŸ“ æ·»åŠ å›å¿†ç‚¹æ¨¡å¼</h3>
                <p style="color: #722F37; font-weight: 600; margin-bottom: 15px;">ç‚¹å‡»åœ°å›¾ä¸Šä»»æ„ä½ç½®æ·»åŠ å›å¿†ç‚¹</p>
                <div style="background: #f0f9f4; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 14px;">
                    ğŸ’¡ æç¤ºï¼šç‚¹å‡»åå°†æ˜¾ç¤ºä½ç½®ç¡®è®¤é€‰é¡¹
                </div>
                <button class="btn-secondary" onclick="cancelAddingMarker()" style="width: 100%;">
                    âŒ å–æ¶ˆæ·»åŠ 
                </button>
            `;
            
            // ä¿å­˜åŸå§‹å†…å®¹ä»¥ä¾¿æ¢å¤
            infoPanel.dataset.originalContent = currentContent;
            
            updateMapStatus('æ·»åŠ æ¨¡å¼å·²æ¿€æ´» - ç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®');
        }
        
        // æ˜¾ç¤ºä½ç½®ç¡®è®¤
        function showLocationConfirmation(mapX, mapY) {
            // åˆ›å»ºä¸´æ—¶æ ‡è®°æ˜¾ç¤ºé€‰ä¸­ä½ç½®
            const tempMarker = document.createElement('div');
            tempMarker.id = 'temp-location-marker';
            tempMarker.style.cssText = `
                position: absolute;
                width: 40px;
                height: 40px;
                background: rgba(114, 47, 55, 0.8);
                border: 3px solid white;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 20px;
                transform: translate(-50%, -50%);
                z-index: 1000;
                animation: pulse 2s infinite;
                pointer-events: none;
            `;
            tempMarker.innerHTML = 'ğŸ“';
            
            // è®¡ç®—æ ‡è®°ä½ç½®
            const containerX = mapOffsetX + mapX * mapScale;
            const containerY = mapOffsetY + mapY * mapScale;
            tempMarker.style.left = `${containerX}px`;
            tempMarker.style.top = `${containerY}px`;
            
            document.getElementById('map-container').appendChild(tempMarker);
            
            // æ›´æ–°ä¿¡æ¯é¢æ¿æ˜¾ç¤ºç¡®è®¤é€‰é¡¹
            const infoPanel = document.querySelector('.info-panel');
            infoPanel.innerHTML = `
                <h3 style="margin-bottom: 15px;">ğŸ“ ç¡®è®¤ä½ç½®</h3>
                <div style="background: #f0f9f4; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                    <p style="font-weight: 600; color: #166534; margin-bottom: 10px;">å·²é€‰æ‹©ä½ç½®ï¼š</p>
                    <p style="font-family: monospace; color: #374151;">åæ ‡: (${Math.round(mapX)}, ${Math.round(mapY)})</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-primary" onclick="confirmLocation()" style="flex: 1;">
                        âœ… ç¡®è®¤ä½ç½®
                    </button>
                    <button class="btn-secondary" onclick="cancelLocation()" style="flex: 1;">
                        ğŸ”„ é‡æ–°é€‰æ‹©
                    </button>
                </div>
                <button class="btn-secondary" onclick="cancelAddingMarker()" style="width: 100%; margin-top: 10px;">
                    âŒ å–æ¶ˆæ·»åŠ 
                </button>
            `;
        }
        
        // ç¡®è®¤ä½ç½®
        function confirmLocation() {
            // åœæ­¢æ·»åŠ æ¨¡å¼ï¼ˆä½†ä¿ç•™ä¸´æ—¶æ ‡è®°ï¼‰
            stopAddingMarker(false);
            
            // æ‰“å¼€æ·»åŠ å›å¿†å¯¹è¯æ¡†
            document.getElementById('memory-modal').classList.add('active');
            
            // èšç„¦åˆ°æ ‡é¢˜è¾“å…¥æ¡†
            setTimeout(() => {
                document.getElementById('memory-title').focus();
            }, 100);
        }
        
        // å–æ¶ˆä½ç½®é€‰æ‹©
        function cancelLocation() {
            // ç§»é™¤ä¸´æ—¶æ ‡è®°
            const tempMarker = document.getElementById('temp-location-marker');
            if (tempMarker) {
                tempMarker.remove();
            }
            
            // é‡ç½®åæ ‡
            clickedCoords = null;
            document.getElementById('marker-coords').value = '';
            
            // æ¢å¤æ·»åŠ æ¨¡å¼æç¤º
            const infoPanel = document.querySelector('.info-panel');
            infoPanel.innerHTML = `
                <h3 style="margin-bottom: 15px;">ğŸ“ æ·»åŠ å›å¿†ç‚¹æ¨¡å¼</h3>
                <p style="color: #722F37; font-weight: 600; margin-bottom: 15px;">ç‚¹å‡»åœ°å›¾ä¸Šä»»æ„ä½ç½®æ·»åŠ å›å¿†ç‚¹</p>
                <div style="background: #f0f9f4; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 14px;">
                    ğŸ’¡ æç¤ºï¼šç‚¹å‡»åå°†æ˜¾ç¤ºä½ç½®ç¡®è®¤é€‰é¡¹
                </div>
                <button class="btn-secondary" onclick="cancelAddingMarker()" style="width: 100%;">
                    âŒ å–æ¶ˆæ·»åŠ 
                </button>
            `;
        }
        
        // æ¸…ç†æ‰€æœ‰ä¸´æ—¶æ ‡è®°
        function clearAllTempMarkers() {
            // æ¸…ç†æ‰€æœ‰ä¸´æ—¶ä½ç½®æ ‡è®°
            const tempMarkers = document.querySelectorAll('#temp-location-marker');
            tempMarkers.forEach(marker => marker.remove());
            
            // é‡ç½®ç›¸å…³çŠ¶æ€
            clickedCoords = null;
            const coordsInput = document.getElementById('marker-coords');
            if (coordsInput) {
                coordsInput.value = '';
            }
        }
        
        // åœæ­¢æ·»åŠ æ ‡è®°æ¨¡å¼
        function stopAddingMarker(clearTemp = false) {
            isAddingMarker = false;
            
            // æ¢å¤åœ°å›¾æ ·å¼
            const mapImage = document.getElementById('campus-map');
            mapImage.classList.remove('adding-marker');
            
            // éšè—æç¤º
            document.getElementById('adding-hint').style.display = 'none';
            
            // åªåœ¨æŒ‡å®šæ—¶æ¸…ç†ä¸´æ—¶æ ‡è®°
            if (clearTemp) {
                clearAllTempMarkers();
            }
            
            // æ¢å¤ä¿¡æ¯é¢æ¿
            const infoPanel = document.querySelector('.info-panel');
            if (infoPanel.dataset.originalContent) {
                infoPanel.innerHTML = infoPanel.dataset.originalContent;
                delete infoPanel.dataset.originalContent;
                updateMemoryCount(); // é‡æ–°æ›´æ–°è®¡æ•°
            }
            
            updateMapStatus('åœ°å›¾åŠ è½½å®Œæˆ - å¯ä»¥å¼€å§‹æ·»åŠ å›å¿†ç‚¹');
        }
        
        function cancelAddingMarker() {
            // æ¸…ç†ä¸´æ—¶æ ‡è®°
            clearAllTempMarkers();
            
            stopAddingMarker(true);
        }
        
        function closeMemoryModal() {
            document.getElementById('memory-modal').classList.remove('active');
            document.getElementById('memory-form').reset();
            
            // æ¸…ç†å›¾ç‰‡ç›¸å…³çŠ¶æ€
            removeImage({stopPropagation: () => {}});
            
            // æ¸…ç†ä¸´æ—¶æ ‡è®°å’Œé‡ç½®çŠ¶æ€
            clearAllTempMarkers();
            
            // å¦‚æœè¿˜åœ¨æ·»åŠ æ¨¡å¼ï¼Œæ¢å¤åˆ°æ­£å¸¸çŠ¶æ€
            if (isAddingMarker) {
                cancelAddingMarker();
            }
        }
        
        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
            document.getElementById('edit-form').reset();
            
            // æ¸…ç†ç¼–è¾‘å›¾ç‰‡çŠ¶æ€ - ä½†ä¸é‡ç½®currentEditImageDataï¼Œé¿å…å½±å“ä¿å­˜
            const preview = document.getElementById('edit-image-preview');
            const uploadText = document.getElementById('edit-upload-text');
            const removeBtn = document.getElementById('edit-remove-image-btn');
            const input = document.getElementById('edit-image-input');
            
            preview.style.display = 'none';
            uploadText.style.display = 'block';
            removeBtn.style.display = 'none';
            input.value = '';
            
            // é‡ç½®currentEditImageDataï¼Œä¸ºä¸‹æ¬¡ç¼–è¾‘åšå‡†å¤‡
            currentEditImageData = null;
        }
        
        function closeViewModal() {
            document.getElementById('view-modal').classList.remove('active');
        }
        
        // æ›´æ–°åœ°å›¾å˜æ¢
        function updateMapTransform() {
            if (!mapLoaded) return;
            
            const mapImage = document.getElementById('campus-map');
            
            mapImage.style.transform = `scale(${mapScale}) translate(${mapOffsetX/mapScale}px, ${mapOffsetY/mapScale}px)`;
            
            // æ›´æ–°æ‰€æœ‰æ ‡è®°ä½ç½®
            updateMarkersPosition();
        }
        
        // ç¼©æ”¾å‡½æ•°
        function zoomIn() {
            if (!mapLoaded) return;
            const oldScale = mapScale;
            mapScale = Math.min(mapScale * 1.3, 3);
            
            // ä»¥åœ°å›¾ä¸­å¿ƒä¸ºç¼©æ”¾ä¸­å¿ƒ
            const mapCenterX = mapOffsetX + (mapWidth * oldScale) / 2;
            const mapCenterY = mapOffsetY + (mapHeight * oldScale) / 2;
            
            mapOffsetX = mapCenterX - (mapWidth * mapScale) / 2;
            mapOffsetY = mapCenterY - (mapHeight * mapScale) / 2;
            
            updateMapTransform();
            updateZoomDisplay();
        }
        
        function zoomOut() {
            if (!mapLoaded) return;
            const oldScale = mapScale;
            mapScale = Math.max(mapScale / 1.3, 0.1);
            
            // ä»¥åœ°å›¾ä¸­å¿ƒä¸ºç¼©æ”¾ä¸­å¿ƒ
            const mapCenterX = mapOffsetX + (mapWidth * oldScale) / 2;
            const mapCenterY = mapOffsetY + (mapHeight * oldScale) / 2;
            
            mapOffsetX = mapCenterX - (mapWidth * mapScale) / 2;
            mapOffsetY = mapCenterY - (mapHeight * mapScale) / 2;
            
            updateMapTransform();
            updateZoomDisplay();
        }
        
        function resetZoom() {
            if (!mapLoaded) return;
            
            mapScale = 0.1; // ä¸åˆå§‹ç¼©æ”¾ä¿æŒä¸€è‡´ï¼Œè®¾ç½®ä¸º10%
            mapOffsetX = (containerWidth - mapWidth * mapScale) / 2;
            mapOffsetY = (containerHeight - mapHeight * mapScale) / 2;
            
            updateMapTransform();
            updateZoomDisplay();
        }
        
        // æ›´æ–°ç¼©æ”¾æ˜¾ç¤º
        function updateZoomDisplay() {
            const zoomPercent = Math.round(mapScale * 100);
            document.getElementById('zoom-display').textContent = `ç¼©æ”¾: ${zoomPercent}%`;
        }
        
        // æ›´æ–°åæ ‡æ˜¾ç¤º
        function updateCoordinateDisplay(x, y) {
            if (isNaN(x) || isNaN(y)) {
                document.getElementById('coordinate-display').textContent = 'åæ ‡: æ— æ•ˆ';
                return;
            }
            document.getElementById('coordinate-display').textContent = `åæ ‡: (${Math.round(x)}, ${Math.round(y)})`;
        }
        
        // æ›´æ–°åœ°å›¾çŠ¶æ€
        function updateMapStatus(status) {
            const statusEl = document.getElementById('map-status');
            if (statusEl) {
                statusEl.textContent = status;
            }
        }
        
        // æ›´æ–°æ ‡è®°ä½ç½®
        function updateMarkersPosition() {
            if (!mapLoaded) return;
            
            document.querySelectorAll('.map-marker').forEach((marker) => {
                const memoryId = marker.dataset.memoryId;
                const memory = memories.find(m => m.id == memoryId);
                if (memory) {
                    const containerX = mapOffsetX + memory.coordinates.x * mapScale;
                    const containerY = mapOffsetY + memory.coordinates.y * mapScale;
                    
                    marker.style.left = `${containerX}px`;
                    marker.style.top = `${containerY}px`;
                }
            });
        }
        
        // é‡è¯•åŠ è½½å›¾ç‰‡
        function retryLoadImage() {
            document.getElementById('loading').innerHTML = '<div>ğŸ“ æ­£åœ¨é‡æ–°åŠ è½½æ ¡å›­åœ°å›¾...</div>';
            const img = document.getElementById('campus-map');
            img.src = 'campus_map_2023.jpg?' + Date.now();
        }
        
        // ä¿å­˜å›å¿†
        document.getElementById('memory-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!clickedCoords) {
                alert('è¯·å…ˆåœ¨åœ°å›¾ä¸Šé€‰æ‹©ä½ç½®');
                return;
            }
            
            const memory = {
                id: Date.now(),
                coordinates: clickedCoords,
                title: document.getElementById('memory-title').value,
                name: document.getElementById('location-name').value || '',
                content: document.getElementById('memory-content').value,
                season: document.getElementById('memory-season').value || '',
                year: document.getElementById('memory-year').value || '',
                emoji: document.getElementById('memory-emoji').value || '',
                image: currentImageData || null,
                date: new Date().toLocaleDateString()
            };
            
            memories.push(memory);
            saveMemories();
            renderMarkers();
            updateMemoryCount();
            
            // æ¸…ç†ä¸´æ—¶æ ‡è®°
            clearAllTempMarkers();
            
            closeMemoryModal();
            
            alert(`å›å¿†"${memory.title}"å·²ä¿å­˜ï¼`);
        });
        
        // æ›´æ–°å›å¿†
        document.getElementById('edit-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const id = parseInt(document.getElementById('edit-memory-id').value);
            const memory = memories.find(m => m.id === id);
            
            if (memory) {
                memory.title = document.getElementById('edit-memory-title').value;
                memory.name = document.getElementById('edit-location-name').value;
                memory.content = document.getElementById('edit-memory-content').value;
                memory.season = document.getElementById('edit-memory-season').value || '';
                memory.year = document.getElementById('edit-memory-year').value || '';
                memory.emoji = document.getElementById('edit-memory-emoji').value || '';
                
                // ä¿®å¤å›¾ç‰‡ä¿å­˜æœºåˆ¶ï¼šå§‹ç»ˆæ›´æ–°å›¾ç‰‡ï¼Œå› ä¸ºcurrentEditImageDataå·²ç»åŒ…å«äº†ç”¨æˆ·çš„æœ€ç»ˆé€‰æ‹©
                // æ— è®ºæ˜¯ä¿æŒåŸå›¾ã€æ›´æ¢æ–°å›¾ã€è¿˜æ˜¯åˆ é™¤å›¾ç‰‡ï¼ŒcurrentEditImageDataéƒ½æ˜¯æ­£ç¡®çš„å€¼
                console.log('ä¿å­˜å‰ - åŸå›¾ç‰‡é•¿åº¦:', memory.image ? memory.image.length : 0);
                console.log('ä¿å­˜å‰ - æ–°å›¾ç‰‡é•¿åº¦:', currentEditImageData ? currentEditImageData.length : 0);
                memory.image = currentEditImageData;
                console.log('ä¿å­˜å - å›¾ç‰‡é•¿åº¦:', memory.image ? memory.image.length : 0);
                
                saveMemories();
                renderMarkers();
                closeEditModal();
                
                alert(`å›å¿†"${memory.title}"å·²æ›´æ–°ï¼`);
            }
        });
        
        function loadMemories() {
            
            const saved = localStorage.getItem('campus-memories-enhanced');
            if (saved) {
                memories = JSON.parse(saved);
                // ä¸ºæ—§æ•°æ®æ·»åŠ ç¼ºå¤±çš„å±æ€§
                memories.forEach(memory => {
                    // ä¸å†ä¸ºæ—§æ•°æ®è®¾ç½®é»˜è®¤å¹´çº§
                    if (!memory.title) {
                        memory.title = memory.name || 'æœªå‘½åå›å¿†';
                    }
                    if (memory.image === undefined) {
                        memory.image = null;
                    }
                    if (memory.emoji === undefined) {
                        memory.emoji = '';
                    }
                });
            } else {
                memories = [
                    {
                        id: 1,
                        coordinates: { x: 1929, y: 2936 },
                        title: 'åœ¨åŒ—é¦†å†™æ¯•è®¾',
                        name: 'åŒ—é¦†',
                        content: 'å¤§å››çš„æ˜¥å¤©åŸºæœ¬éƒ½æ³¡åœ¨è¿™é‡Œå†™æ¯•ä¸šè®ºæ–‡äº†',
                        season: 'spring',
                        year: '2025',
                        emoji: 'ğŸ“š',
                        image: null,
                    },
                    {
                        id: 2,
                        coordinates: { x: 3127, y: 3088 },
                        title: 'ç¬¬ä¸€æ¬¡ä¸‰åƒç±³ï¼',
                        name: 'ä¸œå¤§æ“åœº',
                        content: 'åˆšä¸Šå¤§å­¦çš„ç¬¬ä¸€ä¸ªå­¦æœŸï¼Œåœ¨è¿™é‡Œè·‘å‡ºäº†äººç”Ÿç¬¬ä¸€æ¬¡ä¸‰åƒç±³',
                        season: 'autumn',
                        year: '2021',
                        emoji: 'ğŸƒ',
                        image: null,
                    }
                ];
                saveMemories();
            }
        }
        
        function saveMemories() {
            localStorage.setItem('campus-memories-enhanced', JSON.stringify(memories));
        }
        
        function renderMarkers() {
            if (!mapLoaded) return;
            
            document.querySelectorAll('.map-marker').forEach(marker => marker.remove());
            
            memories.forEach(memory => {
                createMarker(memory);
            });
        }
        
        function createMarker(memory) {
            const marker = document.createElement('div');
            // æ ¹æ®å­£èŠ‚è®¾ç½®æ ·å¼ç±»ï¼Œå¦‚æœæ²¡æœ‰å­£èŠ‚åˆ™ä½¿ç”¨é»˜è®¤
            const seasonClass = memory.season ? `season-${memory.season}` : 'season-default';
            marker.className = `map-marker ${seasonClass}`;
            
            // ä½¿ç”¨è‡ªå®šä¹‰emojiï¼Œå¦‚æœæ²¡æœ‰åˆ™æ ¹æ®å­£èŠ‚é€‰æ‹©ï¼Œæœ€åé»˜è®¤ä¸ºğŸ“
            let markerIcon = memory.emoji || getSeasonIcon(memory.season) || 'ğŸ“';
            marker.innerHTML = markerIcon;
            
            // æ„å»ºæ ‡é¢˜ä¿¡æ¯ï¼Œåªæ˜¾ç¤ºæœ‰å€¼çš„å†…å®¹
            let titleParts = [memory.title || memory.name];
            if (memory.year) titleParts.push(memory.year);
            if (memory.season) titleParts.push(getSeasonName(memory.season));
            marker.title = titleParts.join(' - ');
            
            marker.dataset.memoryId = memory.id;
            
            marker.addEventListener('click', function(e) {
                e.stopPropagation();
                showMemory(memory);
            });
            
            document.getElementById('map-container').appendChild(marker);
        }
        
        function getSeasonIcon(season) {
            if (!season) return ''; // å¦‚æœæ²¡æœ‰å­£èŠ‚ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
            const icons = {
                spring: 'ğŸŒ¸',
                summer: 'ğŸŒ',
                autumn: 'ğŸ‚',
                winter: 'â„ï¸'
            };
            return icons[season] || '';
        }
        
        function getSeasonName(season) {
            const names = {
                spring: 'æ˜¥å¤©',
                summer: 'å¤å¤©',
                autumn: 'ç§‹å¤©',
                winter: 'å†¬å¤©'
            };
            return names[season] || season;
        }
        
        function showMemory(memory) {
            // æ˜¾ç¤ºå¹´ä»½ä¿¡æ¯ï¼ˆåªåœ¨æœ‰å¹´ä»½æ—¶æ˜¾ç¤ºï¼‰
            let yearInfo = '';
            
            if (memory.year && String(memory.year).trim() !== '') {
                yearInfo = memory.year;
            }
            
            // åªåœ¨æœ‰å¹´ä»½æ—¶æ˜¾ç¤ºå¹´ä»½å¾½ç« 
            const yearBadge = yearInfo ? `<span class="grade-badge grade-default">${yearInfo}</span>` : '';
            
            console.log('å¹´ä»½æ˜¾ç¤ºè°ƒè¯•:', {
                year: memory.year,
                yearInfo,
                yearBadge: yearBadge ? 'æœ‰å¾½ç« ' : 'æ— å¾½ç« '
            });
            
            // å­£èŠ‚ä¿¡æ¯ï¼ˆåªåœ¨æœ‰å­£èŠ‚æ—¶æ˜¾ç¤ºï¼‰
            const seasonBadge = memory.season ? `<span class="season-badge season-${memory.season}">${getSeasonIcon(memory.season)} ${getSeasonName(memory.season)}</span>` : '';
            
            // æ ‡é¢˜emojiï¼ˆä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰emojiï¼Œç„¶åæ˜¯å­£èŠ‚emojiï¼‰
            const titleEmoji = memory.emoji || getSeasonIcon(memory.season) || 'ğŸ“';
            
            const locationHtml = memory.name ? `
                <div style="color: #6b7280; font-size: 14px; margin-bottom: 10px;">
                    ğŸ“ ${memory.name}
                </div>
            ` : '';
            
            // åˆ¤æ–­å›¾ç‰‡æ–¹å‘æ¥å†³å®šå¸ƒå±€
            let layoutClass = 'vertical-layout';
            let imageHtml = '';
            
            if (memory.image) {
                // é¢„å…ˆåˆ¤æ–­å›¾ç‰‡å¸ƒå±€ç±»å‹ï¼Œé¿å…æ˜¾ç¤ºåè·³åŠ¨
                const tempImg = new Image();
                tempImg.src = memory.image;
                
                // åŒæ­¥è·å–å›¾ç‰‡å°ºå¯¸ï¼ˆå¦‚æœå·²ç¼“å­˜ï¼‰æˆ–ä½¿ç”¨é»˜è®¤å¸ƒå±€
                let layoutClass = 'vertical-layout'; // é»˜è®¤ç«–å‘å¸ƒå±€
                let maxImageHeight = '200px'; // é»˜è®¤é«˜åº¦
                
                if (tempImg.complete && tempImg.naturalWidth > 0) {
                    // å›¾ç‰‡å·²ç¼“å­˜ï¼Œå¯ä»¥åŒæ­¥è·å–å°ºå¯¸
                    const aspectRatio = tempImg.naturalWidth / tempImg.naturalHeight;
                    if (aspectRatio < 0.8) {
                        layoutClass = 'horizontal-layout';
                        maxImageHeight = '350px';
                    }
                }
                
                imageHtml = `
                    <div class="memory-image-container">
                        <img src="${memory.image}" 
                             class="memory-image" 
                             alt="${memory.title}" 
                             style="max-height: ${maxImageHeight};"
                             onload="
                                // å›¾ç‰‡åŠ è½½å®Œæˆåï¼Œè¿›è¡Œç²¾ç¡®çš„å¸ƒå±€è°ƒæ•´ï¼ˆå¦‚æœéœ€è¦ï¼‰
                                const aspectRatio = this.naturalWidth / this.naturalHeight;
                                const container = this.closest('.memory-main-content');
                                if (container) {
                                    const shouldBeHorizontal = aspectRatio < 0.8;
                                    const currentlyHorizontal = container.classList.contains('horizontal-layout');
                                    
                                    // åªæœ‰åœ¨å¸ƒå±€åˆ¤æ–­ä¸ä¸€è‡´æ—¶æ‰åˆ‡æ¢ï¼Œå‡å°‘è·³åŠ¨
                                    if (shouldBeHorizontal && !currentlyHorizontal) {
                                        container.className = 'memory-main-content horizontal-layout';
                                        // æ¨ªå‘å¸ƒå±€çš„åŠ¨æ€é«˜åº¦è°ƒæ•´
                                        setTimeout(() => {
                                            const textContent = container.querySelector('.memory-text-content');
                                            if (textContent) {
                                                const textHeight = textContent.offsetHeight;
                                                const maxHeight = Math.max(Math.min(textHeight - 30, 350), 180);
                                                this.style.maxHeight = maxHeight + 'px';
                                            }
                                        }, 50);
                                    } else if (!shouldBeHorizontal && currentlyHorizontal) {
                                        container.className = 'memory-main-content vertical-layout';
                                        this.style.maxHeight = '200px';
                                    }
                                }
                            ">
                    </div>
                `;
                
                // æ›´æ–°é»˜è®¤å¸ƒå±€ç±»
                layoutClass = layoutClass;
            }
            
            // æ ¹æ®æ˜¯å¦æœ‰å›¾ç‰‡æ·»åŠ ç›¸åº”çš„CSSç±»
            const hasImageClass = memory.image ? 'has-image' : '';
            
            const content = `
                <div class="memory-content ${hasImageClass}">
                    <button class="close-btn" onclick="closeViewModal()">Ã—</button>
                    
                    <div class="memory-header">
                        <div class="memory-title">
                            <span class="memory-title-emoji">${titleEmoji}</span>
                            <span>${memory.title || memory.name || 'æœªå‘½åå›å¿†'}</span>
                        </div>
                        <div class="memory-badges">
                            ${yearBadge}
                        </div>
                    </div>
                    
                    <div class="memory-body">
                        <div class="memory-main-content ${layoutClass}">
                            ${imageHtml}
                            <div class="memory-text-content">
                                <div class="memory-text-scrollable">
                                    ${locationHtml}
                                    <div class="memory-description">${memory.content}</div>
                                </div>
                                <div class="memory-meta">
                                    <div>
                                        ${seasonBadge}
                                    </div>
                                    <div style="text-align: center;">
                                        <button class="btn-edit" onclick="editMemory(${memory.id}); closeViewModal();">âœï¸ ç¼–è¾‘</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('view-content').innerHTML = content;
            document.getElementById('view-modal').classList.add('active');
        }
        
        function updateMemoryCount() {
            const countEl = document.getElementById('memory-count');
            if (countEl) {
                countEl.textContent = memories.length;
            }
        }
        
        // æ‰“å¼€æ•°æ®ç®¡ç†
        function openDataManagement() {
            updateDataStats();
            refreshDataTable();
            document.getElementById('data-management-modal').classList.add('active');
        }
        
        function closeDataManagement() {
            document.getElementById('data-management-modal').classList.remove('active');
        }
        
        // æ›´æ–°æ•°æ®ç»Ÿè®¡
        function updateDataStats() {
            const total = memories.length;
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const recent = memories.filter(m => {
                const memoryDate = new Date(m.date);
                return memoryDate.getMonth() === currentMonth && memoryDate.getFullYear() === currentYear;
            }).length;
            
            const yearStats = {};
            const seasonStats = {};
            
            memories.forEach(m => {
                if (m.year && String(m.year).trim() !== '') {
                    yearStats[m.year] = (yearStats[m.year] || 0) + 1;
                }
                seasonStats[m.season] = (seasonStats[m.season] || 0) + 1;
            });
            
            document.getElementById('total-memories').textContent = total;
            document.getElementById('recent-memories').textContent = recent;
            document.getElementById('year-distribution').textContent = Object.keys(yearStats).length;
            document.getElementById('season-distribution').textContent = Object.keys(seasonStats).length;
        }
        
        // åˆ·æ–°æ•°æ®è¡¨æ ¼
        function refreshDataTable() {
            const tbody = document.getElementById('data-table-body');
            tbody.innerHTML = '';
            
            memories.forEach(memory => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${memory.title || memory.name}</strong>
                        <br><small style="color: #666;">${memory.content.substring(0, 30)}...</small>
                    </td>
                    <td>${memory.name || '-'}</td>
                    <td><code>(${memory.coordinates.x}, ${memory.coordinates.y})</code></td>
                    <td><span class="season-badge season-${memory.season}">${getSeasonIcon(memory.season)} ${getSeasonName(memory.season)}</span></td>
                    <td>${memory.year && String(memory.year).trim() !== '' ? memory.year : '-'}</td>
                    <td>
                        <button class="btn-edit" onclick="editMemory(${memory.id})">âœï¸ ç¼–è¾‘</button>
                        <button class="btn-danger" onclick="deleteMemory(${memory.id})">ğŸ—‘ï¸ åˆ é™¤</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // ç¼–è¾‘å›å¿†
        function editMemory(id) {
            const memory = memories.find(m => m.id === id);
            if (!memory) return;
            
            document.getElementById('edit-memory-id').value = memory.id;
            document.getElementById('edit-marker-coords').value = `${memory.coordinates.x}, ${memory.coordinates.y}`;
            document.getElementById('edit-memory-title').value = memory.title || memory.name || '';
            document.getElementById('edit-location-name').value = memory.name || '';
            document.getElementById('edit-memory-content').value = memory.content;
            document.getElementById('edit-memory-season').value = memory.season || '';
            document.getElementById('edit-memory-year').value = memory.year || '';
            document.getElementById('edit-memory-emoji').value = memory.emoji || '';
            
            // è®¾ç½®ç¼–è¾‘å›¾ç‰‡ - é‡è¦ï¼šåˆå§‹åŒ–ä¸ºåŸå§‹å›¾ç‰‡
            currentEditImageData = memory.image;
            console.log('ç¼–è¾‘å¼€å§‹ - åˆå§‹åŒ–å›¾ç‰‡é•¿åº¦:', currentEditImageData ? currentEditImageData.length : 0);
            const preview = document.getElementById('edit-image-preview');
            const uploadText = document.getElementById('edit-upload-text');
            const removeBtn = document.getElementById('edit-remove-image-btn');
            const input = document.getElementById('edit-image-input');
            
            // é‡ç½®input
            input.value = '';
            
            if (memory.image) {
                preview.src = memory.image;
                preview.style.display = 'block';
                uploadText.style.display = 'none';
                removeBtn.style.display = 'block';
            } else {
                preview.style.display = 'none';
                uploadText.style.display = 'block';
                removeBtn.style.display = 'none';
            }
            
            closeDataManagement();
            document.getElementById('edit-modal').classList.add('active');
        }
        
        // åˆ é™¤å›å¿†
        function deleteMemory(id) {
            const memory = memories.find(m => m.id === id);
            const title = memory ? (memory.title || memory.name) : 'æ­¤å›å¿†';
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤å›å¿†"${title}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                memories = memories.filter(m => m.id !== id);
                saveMemories();
                renderMarkers();
                updateMemoryCount();
                refreshDataTable();
                updateDataStats();
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                memories = [];
                saveMemories();
                renderMarkers();
                updateMemoryCount();
                refreshDataTable();
                updateDataStats();
                alert('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º');
            }
        }
        
        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const dataStr = JSON.stringify(memories, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `æ¸…åå›å¿†åœ°å›¾-${new Date().toLocaleDateString()}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
        }

        
        // å¯¼å…¥æ•°æ®
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (Array.isArray(data)) {
                                if (confirm(`ç¡®å®šè¦å¯¼å…¥ ${data.length} æ¡å›å¿†æ•°æ®å—ï¼Ÿç°æœ‰æ•°æ®å°†è¢«è¦†ç›–ã€‚`)) {
                                    memories = data;
                                    saveMemories();
                                    renderMarkers();
                                    updateMemoryCount();
                                    refreshDataTable();
                                    updateDataStats();
                                    alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                                }
                            } else {
                                alert('æ— æ•ˆçš„æ•°æ®æ ¼å¼');
                            }
                        } catch (error) {
                            alert('æ–‡ä»¶è§£æå¤±è´¥: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        
        // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è®¡ç®—
        window.addEventListener('resize', function() {
            if (!mapLoaded) return;
            
            const mapContainer = document.getElementById('map-container');
            containerWidth = mapContainer.offsetWidth;
            containerHeight = mapContainer.offsetHeight;
            updateMapTransform();
        });
        
        // Infoå¼¹çª—ç›¸å…³å‡½æ•°
        function openInfoModal() {
            document.getElementById('info-modal').style.display = 'block';
        }
        
        function closeInfoModal() {
            document.getElementById('info-modal').style.display = 'none';
        }
        
        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('info-modal');
            if (event.target === modal) {
                closeInfoModal();
            }
        });
    </script>
    
    <!-- ä½œè€…ä¿¡æ¯ -->
    <div class="author-info">
        <span>by Daniel Wong</span>
        <div class="info-icon" onclick="openInfoModal()" title="å…³äºé¡¹ç›®">i</div>
    </div>
    
    <!-- Infoå¼¹çª— -->
    <div id="info-modal" class="info-modal">
        <div class="info-modal-content">
            <button class="close-btn" onclick="closeInfoModal()">&times;</button>
            <h3>ğŸ“ å…³äºæ¸…åå›å¿†åœ°å›¾</h3>
            <p>è¿™æ˜¯ä¸€ä¸ªç”¨äºè®°å½•å’Œåˆ†äº«æ¸…åå¤§å­¦æ ¡å›­å›å¿†çš„äº¤äº’å¼åœ°å›¾åº”ç”¨ã€‚</p>
            
            <p><strong>ğŸ‘¨â€ğŸ’» åˆ›ä½œè€…ï¼š</strong><br>
            Daniel Wong<br>
            ä¸€å­—ç­ History of Art</p>
            
            <p><strong>ğŸ’¡ ä½¿ç”¨æŒ‡å—ï¼š</strong><br>
            é™¤äº†åŸºç¡€çš„ä½¿ç”¨æ–¹å¼ä¹‹å¤–ï¼š<br>
            â€¢ è®°å½•ç®¡ç†-å¯¼å‡º/å¯¼å…¥æ•°æ®ï¼Œå¯ä»¥å°†ä½ çš„è®°å½•ç‚¹ä¸æœ‹å‹ä¸€èµ·åˆ†äº«ã€‚<br>
            â€¢ è®°å½•ç®¡ç†-å¯¼å‡ºæ•°æ®-æ¸…ç©ºï¼Œå¯ä»¥ä¿ç•™å¤šç‰ˆä¸åŒä¸»é¢˜çš„æ•°æ®ã€‚ä½ å¯ä»¥åœ¨ä»“åº“é‡Œæ‰¾åˆ°æˆ‘çš„â€œä¼¤æ˜¥æ‚²ç§‹â€ä¸“é¢˜â€”â€”ä¹‹æ‰€ä»¥æ”¾è¿™ä¸ªä¸“é¢˜ä¸Šæ¥ï¼Œæ˜¯å› ä¸ºå®ƒå®Œå…¨ä¸æš´éœ²éšç§ :)<br>
            
            <p><strong>ğŸ§ ä¸ºä»€ä¹ˆæƒ³åšè¿™æ ·ä¸€ä¸ªç½‘é¡µï¼š</strong><br>
            åœ¨ 2025 å¹´çš„ç§‹å¤©ï¼ŒåŒ—äº¬æœ€ç¾çš„æ—¶å€™ï¼Œåˆå›äº†ä¸€æ¬¡æ¸…åã€‚å¯¹è¿™é‡Œçš„æ„Ÿæƒ…ï¼Œä¼¼ä¹æ¯”æˆ‘æƒ³è±¡ä¸­æ›´çº ç¼ ä¸æ¸…ã€‚<br>
            ä¸æœ‹å‹åšäº†å¾ˆå¤šå¯¹äºç”Ÿæ´»æ–¹å¼çš„è®¨è®ºï¼Œé«˜ä¸­ä»¥æ¥çš„å¹¼ç¨šçš„ä¿¡ä»°æ˜¯ç”Ÿæ´»æœ¬èº«æ˜¯ç†è®ºçš„å¤–åŒ–ï¼Œä¹Ÿå°±æ˜¯æ¯å¤© 24 ä¸ªå°æ—¶å°±æ˜¯æˆ‘è¿›è¡Œé›•åˆ»çš„å¤§ç†çŸ³ï¼Œåˆ€åˆƒåˆ™æ˜¯æˆ‘è¯»çš„ä¹¦ã€åšçš„ç ”ç©¶ä»¥åŠä¿¡å¥‰çš„ç†è®ºï¼Œæœ´ç´ æ¥è®²ï¼Œæ‰€è°“ã€Œèº«ä½“åŠ›è¡Œã€ï¼Œè‡ªè´Ÿæ¥è¯´ï¼Œç ”ç©¶è‰ºæœ¯å²å´ä¸èƒ½æŠ½ç¦»ä¹‹å¸¦æ¥çš„ã€Œåé—ç—‡ã€ã€‚è€Œè¿™ä¸ªä¿¡ä»°åœ¨æˆ‘æ¯•ä¸šä¹‹åä¸€éä¸€éå¤ç›˜æˆ‘çš„å¤§å­¦ routine ï¼Œå¹¶ä¸”æœ€ç»ˆéœ€è¦æ‰¿è®¤æˆ‘è¿‡äº†éå¸¸å¤šæ— æ„ä¹‰çš„ç”Ÿæ´»æ—¶é‡åˆ°äº†ä¸¥é‡çš„å±æœºâ€”â€”æ›´ä¸¥é‡çš„å¯èƒ½æ˜¯ä»Šå¤©å›å­¦æ ¡ä¹‹åå‘ç°è¿™æ ·çš„æƒ¯æ€§å¹¶æ²¡æœ‰æ”¹å˜ã€‚æ‰€è°“æ— æ„ä¹‰çš„ç”Ÿæ´»å¹¶ä¸åœ¨äºè€½æººç©ä¹ï¼ˆé‚£æ˜¯å·ç‹å®³æ€•çš„ï¼‰ï¼Œä¹Ÿä¸åœ¨äºæœä¸‰æš®å››ï¼ˆé‚£æ˜¯ç¦…è€…å¿Œæƒ®çš„ï¼‰ï¼Œè€Œåœ¨äºå¤„äºè™šæ— ã€æ¸¸ç¦»å’Œæ— æ³•è‡ªæŒçš„çŠ¶æ€ï¼Œå¹¶ä¸”åœ¨ä½œå¹´ç»ˆæ€»ç»“æ—¶ç”¨å‡ ç‚¹é«˜å…‰ç›–è¿‡æ—¥å¸¸çš„æ— æ„ä¹‰ï¼Œç„¶åå®‰æ…°è‡ªå·±ä¸€åˆ‡éƒ½å¥½ã€‚<br>
            æˆ‘æ˜¯åœ¨å¤§å­¦æœ€åä¸€ä¸ªå­¦æœŸï¼Œç¿»éåŠå¹´ä¹Ÿæ‰¾ä¸åˆ°æ„ä¹‰é«˜ç‚¹çš„æ—¶å€™ï¼Œåˆæ¬¡å‘ç°è¿™ä¸ªé—®é¢˜çš„ã€‚è€Œå¯¹äºå››å¹´é—´è¿™æ ·çš„ç”Ÿæ´»ï¼Œæœ€å¥½çš„çºªå¿µæ–¹å¼ä¾¿æ˜¯å°†å…¶å½»åº•åœ°å˜æˆç”µå½±å¸§ï¼Œç„¶åç•™å¾…è®°å¿†ä¸€ééåœ°æ·¡åŒ–æˆ–è€…é‡å†™ã€‚æˆ‘äºæ˜¯åšäº†è¿™æ ·ä¸€ä¸ªç½‘ç«™ï¼Œç­‰å¾…æ„ä¹‰è‡ªæˆ‘æ˜¾ç°çš„æ—¶åˆ»ã€‚</p>
            
            <p style="text-align: center; margin-top: 20px; color: #722F37; font-weight: bold;">
            æœŸå¾…ä½ å†™ä¸‹è‡ªå·±çš„é‚£ä»½æ•…äº‹ã€‚
            </p>
        </div>
    </div>
</body>
</html>